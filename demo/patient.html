<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patient</title>
    <link rel="stylesheet" href="./css/global.css">
    <link rel="stylesheet" href="./css/patient.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<header>
    SKOP<span class="copyright">Â®</span> API
</header>

<div  id="div-patient">

    <div id="subscriber">

    </div>

    <div class="publisherContainer">
        <div id="publisher">
        </div>
    </div>


</div>
<p id="p-powered">powered by WEMED</p>
<div id="inputDevices">

</div>

<div id="controls">
    <input type="checkbox" id="mute">
    <label for="mute">
        <img id="unmuted" src="https://img.icons8.com/ffffff/ios/50/null/microphone.png"/>
        <img id="muted" src="https://img.icons8.com/ffffff/ios/50/null/no-microphone--v1.png"/>
    </label>



    <button id="quitter">
        <img src="https://img.icons8.com/ffffff/ios/50/null/phone.png"/>
    </button>

    <input type="checkbox" id="video">
    <label for="video">
        <img id="visibleVideo" src="https://img.icons8.com/ffffff/ios/50/null/video-call.png"/>
        <img id="hiddenVideo"  src="https://img.icons8.com/ffffff/ios/50/null/no-video--v1.png"/>
    </label>
</div>



</body>
<script src="./SkopAPI.js"></script>
<script defer>
    let btnEnd = document.getElementById("quitter");
    let btnMute = document.getElementById("mute");
    let btnVideo = document.getElementById("video");


    async function patient(){
        //get session id in url
        let url = new URL(window.location.href);
        let room = url.searchParams.get("room");


        if(room == null){
            //room random
            room = Math.floor(Math.random() * (9999 - 1000 + 1)) + 1000;
        }

        console.log(room);



        let patient = await SkopAPI.Patient.init("4bbb7277-6f18-48a9-873a-04a90afe853a",room);




        btnEnd.addEventListener("click",function(){
            if(patient == undefined){
                window.location.href = "endCall.html";
            }else{
                patient.disconnect();
                window.location.href = "endCall.html";
            }
        });

        btnMute.addEventListener("click",function(){
            let muted = document.getElementById("muted");
            let unmuted = document.getElementById("unmuted");

           if(btnMute.checked){
               patient.publishAudio(false);
               muted.style.display = "block";
               unmuted.style.display = "none";
           }
           else{
                patient.publishAudio(true);
                muted.style.display = "none";
                unmuted.style.display = "block";
           }
        });

        btnVideo.addEventListener("click",function(){
            let visibleVideo = document.getElementById("visibleVideo");
            let hiddenVideo = document.getElementById("hiddenVideo");

            if(btnVideo.checked){
                patient.publishVideo(false);
                visibleVideo.style.display = "none";
                hiddenVideo.style.display = "block";
            }
            else{
                patient.publishVideo(true);
                visibleVideo.style.display = "block";
                hiddenVideo.style.display = "none";
            }
        });

        const setInput = (device) => {
            console.log("selectAudioInputDevice", device);
            patient.setInputDevice(device.deviceId);
        }
        let btnDevices = document.getElementById("devices");
        let inputDevices = document.getElementById("inputDevices");
        btnDevices.addEventListener("click",function(){
            patient.getMediaDevices().then(function (devices) {
                //console.log(devices);

                // get audio input devices
                let audioInputDevices = devices.filter(function (device) {
                    return device.kind === 'audioinput';
                });

                // get label of audio input devices
                let audioInputLabels = audioInputDevices.map(function (device) {
                    return device.label;
                });
                console.log(audioInputLabels);

                //foreach audio input device create a radio button and add it to the inputDevices div
                // when the radio button is clicked, the setInput function is called with the device as parameter
                inputDevices.innerHTML = "";
                inputDevices.style.display = "block";
                audioInputDevices.forEach(function (device) {

                    let radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'audioSource';
                    radio.id = device.deviceId;
                    radio.value = device.deviceId;
                    radio.onclick = () => setInput(device);
                    inputDevices.appendChild(radio);

                    let label = document.createElement('label');
                    label.htmlFor = device.deviceId;
                    label.appendChild(document.createTextNode(device.label));
                    inputDevices.appendChild(label);

                    let br = document.createElement('br');
                    inputDevices.appendChild(br);
                });

            });
        });



    }
    patient();
</script>
</html>