<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patient</title>
    <link rel="stylesheet" href="./css/global.css">
    <link rel="stylesheet" href="./css/patient.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<header>
    <h1>SKOP<span class="copyright">®</span> API</h1>
</header>

<div class="backgroundThrough" id="div-patient">
    <div id="container-subscriber-publisher">

        <div id="div-subscriber">
            <div id="subscriber" class="video"></div>
            <p class="role">MÉDECIN</p>
        </div>

        <div id="div-publisher">
            <div id="publisher" class="video"></div>

            <p class="role">PATIENT</p>
        </div>
    </div>

    <div id="inputDevices">

    </div>

    <button id="devices">devices</button>
    <button id="end" class="button" href="endCall.html">DÉCONNEXION</button>
</div>
<p id="p-powered">powered by WEMED</p>


</body>
<script src="../dist/SkopAPI.js"></script>
<script defer>
    let btnEnd = document.getElementById("end");

    let btnDevices = document.getElementById("devices");

    async function patient(){
        //get session id in url
        let url = new URL(window.location.href);
        let room = url.searchParams.get("room");
        let inputDevices = document.getElementById("inputDevices");

        if(room == null){
            //room random
            room = Math.floor(Math.random() * (9999 - 1000 + 1)) + 1000;
        }

        console.log(room);



        let patient = await SkopAPI.Patient.init("4bbb7277-6f18-48a9-873a-04a90afe853a",room);

        const setInput = (device) => {
            console.log("selectAudioInputDevice", device);
            patient.setInputDevice(device.deviceId);
        }



        btnEnd.addEventListener("click",function(){
            if(patient == undefined){
                window.location.href = "endCall.html";
            }else{
                patient.disconnect();
                window.location.href = "endCall.html";
            }
        });


        btnDevices.addEventListener("click",function(){
            patient.getMediaDevices().then(function (devices) {
                //console.log(devices);

                // get audio input devices
                let audioInputDevices = devices.filter(function (device) {
                    return device.kind === 'audioinput';
                });

                // get label of audio input devices
                let audioInputLabels = audioInputDevices.map(function (device) {
                    return device.label;
                });
                console.log(audioInputLabels);


                // inputDevices.innerHTML = audioInputDevices.map(function (device) {
                //     return '<input type="radio" name="audioSource" onclick="() => console.log(device)" id="' + device.deviceId + '" value="' + device.deviceId + '">' +
                //         '<label for="' + device.deviceId + '">' + device.label + '</label><br>';
                // }).join('\n');

                //foreach audio input device create a radio button and add it to the inputDevices div
                // when the radio button is clicked, the setInput function is called with the device as parameter
                audioInputDevices.forEach(function (device) {
                    let radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'audioSource';
                    radio.id = device.deviceId;
                    radio.value = device.deviceId;
                    radio.onclick = () => setInput(device);
                    inputDevices.appendChild(radio);

                    let label = document.createElement('label');
                    label.htmlFor = device.deviceId;
                    label.appendChild(document.createTextNode(device.label));
                    inputDevices.appendChild(label);

                    let br = document.createElement('br');
                    inputDevices.appendChild(br);
                });

            });
        });



    }
    patient();
</script>
</html>